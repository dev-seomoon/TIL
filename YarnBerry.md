Reference : https://toss.tech/article/node-modules-and-yarn-berry

# Yarn Berry

새로운 Node.js 패키지 관리 시스템.

## 기존 npm 패키지 관리 시스템의 문제점

비효율적이거나 깨져 있는 부분이 많다.

1. 비효율적인 의존성 검색 :
   npm은 파일 시스템을 이용해 의존성을 관리한다. node_modules에서 패키지를 검색할 때
   패키지를 찾기 위해서 계속 상위 디렉토리의 node_modules 폴더를 탐색한다.
   패키지를 바로 찾지 못할수록 느린 I/O 호출(readdir, stat 등)이 반복됨.
   경우에 따라서는 I/O 호출이 중간에 실패하기도 함.

2. 환경에 따라 달라지는 동작 :
   의존성 검색 시, 상위 디렉토리 환경에 따라
   어떤 의존성을 찾을 수 있는지가 달라짐.

3. 설치 문제 :
   node_modules는 매우 큰 공간을 차지하고, node_modules 디렉토리 구조를 만들기 위해서 많은 I/O 작업이 필요하다.
   디렉토리 구조도 복잡해서 설치가 유효한지 검증하기도 어렵다.

4. 유령 의존성 : 디스크 공간을 아끼기 위해서 의존성 트리에 끌어올리기(Hosting) 기법을 사용하는데,
   이로 인해 직접 의존하고 있지 않은 라이브러리를 require()할 수 있는 현상(유령 의존성)이 생겨
   의존성 관리 시스템을 혼란스럽게 만든다.

## 해결책 : Plug'n'Play (PnP)

디스크에 node_modules 디렉토리 구조를 만드는 기존 방식 대신에,
좀 더 근본적으로 안전하게 의존성을 관리하기 위해 등장함.

```
$ npm install -g yarn
$ cd ../path/to/some-package
$ yarn set version berry
```

yarn install로 의존성을 설치했을 때, node_modules를 생성하지 않고
.yarn/cache 폴더에 의존성 정보가 저장되고,
.pnp.cjs 파일에 의존성 탐색을 위한 정보가 기록된다.
.pnp.cjs를 이용하면 디스크 I/O 없이 어떤 패키지가 어떤 라이브러리에 의존하는지,
각 라이브러리는 어디에 위치하는지를 바로 알 수 있다.

PnP API를 사용해서 의존성 관리를 할 때는 `node` 명령어 대신 `yarn node` 명령어를 사용해야 함. (node.js의 `require()`문 동작을 덮어씌우기 때문)
`yarn dev` 등 스크립트를 실행하면 자동으로 PnP로 의존성을 불러온다.

zero-install을 사용해서 대부분의 라이브러리를 설치 없이 사용할 수 있다.
-> CI와 같이 반복적으로 의존성 설치 작업이 이루어지는 곳에서 시간을 크게 절약할 수 있다.

### ZipFS (Zip Filesystem)

yarn PnP 시스템에서 의존성은 Zip 아카이브로 관리됨.
node_modules 디렉토리 구조를 생성할 필요가 없어서 설치가 신속히 완료되고,
패키지 버전별로 하나의 zip 아카이브만 가지기 때문에 중복 설치가 되지 않고,
압축되어 있어 스토리지 용량도 크게 아낄 수 있다.
파일 수가 많지 않아서 의존성 관리(변경 사항 감지, 의존성 삭제 등)가 편리하다.

### Zero-Install

yarn PnP는 의존성을 압축 파일로 관리하고, 각 의존성이 하나의 zip 파일로만 표현되기 때문에
의존성의 용량과 파일 숫자가 적다.
따라서 의존성을 git으로 관리할 수 있게 된다. 이렇게 의존성을 git으로 버전 관리하는 것을
Zero-Install이라고 한다.

Zero-Install을 하면
새로 저장소를 클론 받았을 때나 브랜치를 바꿨을 때 yarn install을 하지 않아도 되고,
CI에서 의존성을 설치하는 시간을 크게 절약할 수 있다.
=> **빌드와 배포 시간 크게 단축**

+) .yarn/install-state.gz : 커밋 X. 프로젝트의 현재 상태 저장해두는 파일.
