# 쿠버네티스

https://secret-scooter-97c.notion.site/ft_services-d8e0408fd3a845f29074dc47a19fb320

## 쿠버네티스란

- 쿠버네티스 : 컨테이너 오케스트레이션 도구. 다른 컨테이너 오케스트레이션 도구보다 비교적 늦게 등장함. 현재 쿠버네티스는 사실상의 표준. 쿠버네티스는 컨테이너를 쉽고 빠르게 배포/확장하고 관리를 자동화해주는 오픈소스 플랫폼이다. OS에 접속해 프로그램을 직접 설치할 필요 없이 쿠버네티스에 컨테이너를 배포하고, 네트워크와 스토리지 설정을 하면 된다. 다양한 기능이 쿠버네티스 플랫폼 위에서 동작한다.

- 컨테이너 오케스트레이션 : 컨테이너의 배포, 관리, 확장, 네트워킹을 자동화하는 것.

  - **여러 개의 서버에 컨테이너를 배포하고 운영**하면서 서비스 디스커버리 같은 기능을 이용하여 서비스 간 연결을 쉽게 해준다.
  - 서버마다 이름을 지어주고 하나만 접속하여 관리하는 것이 아니라 여러 개의 서버를 하나로 묶어
  - 적당한 서버를 자동으로 선택해 애플리케이션을 배포하고,
  - 부하가 생기면 컨테이너를 늘리고,
  - 일부 서버에 장애가 발생하면 정상 동작 중인 서버에 다시 띄워 장애를 방지한다.

## 쿠버네티스의 특징

- 거대한 커뮤니티와 생태계
- 다양한 배포방식 지원
  - Deployment : 새로운 버전의 어플리케이션을 다양한 전략으로 무중단 배포할 수 있음
  - StatefulSets : 실행 순서를 보장하고 호스트 이름과 볼륨을 일정하게 사용할 수 있음
  - DaemonSet : 로그나 모니터링 등, 모든 노드에 설치가 필요한 경우 사용
  - Job, CronJob : 배치성 작업에 사용
- Ingress 설정
  - 다양한 웹 애플리케이션을 **하나의 로드 밸런서**로 서비스하기 위해, Ingress 기능을 제공한다.
  - 웹 애플리케이션 배포 과정 : 외부에서 직접 접근할 수 없도록 애플리케이션을 내부망에 설치하고, 외부에서 접근이 가능한 `ALB`, `Nginx`, `Apache`를 프록시 서버로 활용한다. 프록시 서버는 도메인과 Path에 따라 등록된 서버로 요청을 전달하는데, 서버가 바뀌거나 IP가 변경되면 매번 설정을 수정해줘야 한다.
  - 쿠버네티스의 Ingress는 이를 자동화하면서, 기존 프록시 서버에서 사용하는 설정도 거의 그대로 사용할 수 있다. 새로운 도메인을 추가하거나 업로드 용량을 제한하기 위해 일일히 프록시 서버에 접속하여 설정할 필요가 없다.
  - 하나의 클러스터에 여러 개의 Ingress 설정을 할 수 있어, 관리자 접속용 Ingress와 일반 접속용 Ingress를 따로 관리할 수 있다.
- 클라우드 지원
  - 쿠버네티스는 클라우드별로 모듈이 필요하다. (외부 스토리지를 내부 디렉토리에 마운트하거나, 부하에 따라 자동으로 서버를 늘리는 기능, IP를 할당받아 로드밸런서로 사용하는 기능 등을 위해)
  - Cloud Controller를 사용해 클라우드 연동을 쉽게 확장할 수 있다. 여러 클라우드 업체에서 모듈을 제공하여, 동일한 설정 파일을 서로 다른 클라우드에서 동일하게 사용할 수 있다.
- Namespace & Label
  - 하나의 클러스터를 논리적으로 구분해 사용할 수 있다.
  - 하나의 클러스터에 다양한 프레임워크와 애플리케이션을 설치하기 때문에, 기본 system, default 외에 여러 개의 네임스페이스를 사용하는 것이 일반적이다.
  - 더 세부적인 설정으로, 라벨 기능을 적극적으로 사용해 유연하면서 확장성있게 리소스를 관리할 수 있다.
- RBAC (Role-Based Access Control) : 접근 권한 시스템.
  - 각각의 리소스에 대해 유저별로 CRUD등의 권한을 손쉽게 지정할 수 있다.
  - 클러스터 전체에 적용하거나, 특정 네임스페이스에 적용할 수 있다.
- CRD (Custom Resource Definition)
  - 쿠버네티스가 제공하지 않는 기능을 기존 기능과 동일한 방식으로 적용하고 사용할 수 있다.
  - ex) 쿠버네티스는 기본적으로 SSL 인증서 관리 기능을 제공하지 않지만, cert-manager를 설치하고 Certificate 리소스를 이용하면,익숙한 쿠버네티스 명령어로 인증서를 관리할 수 있다.
- Auto Scaling
  - [https://opentutorials.org/course/608/3010](https://opentutorials.org/course/608/3010)
  - CPU, 메모리 사용량에 따른 확장 / 현재 접속자 수와 같은 값을 사용할 수도 있다.
  - HPA(Horizontal Pod Autoscaler) : 컨테이너 개수 조정
  - VPA(Vertical Pod Autoscaler) : 컨테이너의 리소스 할당량 조정
  - CA(Cluster Autoscaler) : 서버 개수 조정
- Federation, Multi Cluster
  - 클라우드에 설치한 쿠버네티스 클러스터 + 자체 서버에 설치한 쿠버네티스 클러스터를묶어서 하나로 사용할 수 있다.
  - Anthos를 이용하면 한 곳에서 여러 클라우드의 여러 클러스터를 관리할 수 있다.
- 단점
  - 기능이 많기 때문에 복잡하고, 초반에 개념을 이해하기 어렵다.
  - 설정 파일이 너무 많고, 클러스터를 만드는 것도 쉽지 않다. 하지만 여러 클라우드에서 관리형 서비스를 제공하므로, Cloud Code 같은 플러그인을 사용하거나 helm 같은 패키지 매니저를 사용하면 비교적 편리하게 설정파일을 관리할 수 있다.

## 쿠버네티스 기본 개념

---

- '/healthz' 엔드포인트 :
  헬스 체크를 위한 엔드포인트.
  API 서버가 활성 상태인지 확인하려면 '/healthz/liveness' 엔드포인트,
  API 서버가 준비 상태인지 확인하려면 '/healthz/readiness' 엔드포인트,
  각 엔드포인트에서 상태 코드 200이 응답되면 현재 API 서버가 healthy / live / ready 상태이다.

  '/healthz' 엔드포인트는 현재 deprecated 되었고,
  '/livez', '/readyz' 엔드포인트를 사용해서 상태를 좀 더 구체적으로 나타낸다.

  엔드포인트에 `-z` 를 붙이는 것은 Google 내부 관행에서 비롯된 것으로,
  일반 엔드포인트와 구분하기 위해서이다.

  - Reference :
    - https://kubernetes.io/ko/docs/reference/using-api/health-checks/
    - https://vimeo.com/173610242
